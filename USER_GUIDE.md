## Руководство пользователя: TORO Maintenance Orders API

Документ описывает, как локально поднять и использовать REST API для создания и отслеживания заявок на техническое обслуживание оборудования. Руководство предназначено для инженеров сопровождения, операторов ремонтных служб и разработчиков, которые интегрируют внешний фронтенд или процессы с системой ТОРО.

---

### 1. Быстрый старт
- **Требования:** Python 3.11+, `pip`, доступ к интернету для установки зависимостей.
- **Установка зависимостей:**
  ```bash
  python -m venv .venv
  source .venv/bin/activate        # Windows: .venv\Scripts\activate
  pip install -r requirements.txt
  ```
- **Запуск API:**
  ```bash
  python app.py
  # Сервер слушает http://localhost:5000
  ```
- **Проверка работы:**
  ```bash
  curl http://localhost:5000/api/v1/orders
  # Ожидаемый ответ: {"orders": [], "total": 0} до создания первых заявок
  ```

---

### 2. Настройки окружения
- `TORO_DATABASE_URL` — путь к SQLite (по умолчанию `sqlite:///toro.db`). Пример переопределения:
  ```bash
  export TORO_DATABASE_URL=sqlite:////tmp/toro.db
  ```
- Порт фиксирован на `5000`; при необходимости используйте прокси/SSH-тоннель.
- CORS включён для всех доменов. В продакшене ограничьте список источников в `app.py` (инициализация `CORS`).

---

### 3. Модель данных
| Поле            | Тип        | Обязательное | Описание                                       |
|-----------------|------------|--------------|------------------------------------------------|
| `id`            | Integer PK | да           | Уникальный идентификатор записи               |
| `order_number`  | String     | да           | Генерируется автоматически в формате `TORO-YYYY-NNN` |
| `equipment_type`| String     | да           | Тип оборудования (напр. «Станок ЧПУ»)          |
| `equipment_id`  | String     | да           | Инвентарный номер                              |
| `issue_description` | Text   | да           | Подробное описание неисправности               |
| `priority`      | Enum       | да           | `low`, `medium`, `high` (по умолчанию `medium`)|
| `status`        | Enum       | да           | `created`, `in_progress`, `completed`          |
| `requester_name`| String     | да           | ФИО инициатора                                 |
| `department`    | String     | да           | Цех/подразделение                              |
| `contact_phone` | String     | да           | Формат `+7-XXX-XXX-XX-XX`                      |
| `created_at`    | DateTime   | да           | Автозаполняется                                 |
| `updated_at`    | DateTime   | да           | Автозаполняется при изменениях                  |

---

### 4. Эндпоинты API

#### 4.1 Создание заявки — `POST /api/v1/orders`
```bash
curl -X POST http://localhost:5000/api/v1/orders \
  -H "Content-Type: application/json" \
  -d '{
        "equipment_type": "Станок ЧПУ",
        "equipment_id": "CNC-001",
        "issue_description": "Перегрев шпинделя",
        "priority": "high",
        "requester_name": "Иванов Иван",
        "department": "Цех №1",
        "contact_phone": "+7-900-123-45-67"
      }'
```
**Ответ (201):**
```json
{
  "id": 1,
  "order_number": "TORO-2025-001",
  "priority": "high",
  "status": "created",
  "...": "прочие поля из модели"
}
```

#### 4.2 Список заявок — `GET /api/v1/orders`
- **Параметры фильтрации:** `priority`, `status`, `department` (все опциональны).
- **Примеры:**
  ```bash
  curl http://localhost:5000/api/v1/orders?priority=high
  curl "http://localhost:5000/api/v1/orders?status=in_progress&department=Цех%20№2"
  ```
- **Ответ (200):**
  ```json
  {
    "orders": [ { ... }, { ... } ],
    "total": 2
  }
  ```

#### 4.3 Получение заявки по ID — `GET /api/v1/orders/<id>`
```bash
curl http://localhost:5000/api/v1/orders/1
```
**Ответ (200):** объект заказа.  
**Ошибка 404:** если заказ не найден.

---

### 5. Валидация
- Обязательные поля перечислены в таблице данных.
- `priority` ∈ `{low, medium, high}`; `status` управляется сервером и всегда начинается с `created`.
- `contact_phone` должен соответствовать маске `+7-XXX-XXX-XX-XX`.
- Тело запроса — JSON-объект; пустой/невалидный JSON приведёт к ошибке `400` с описанием.

---

### 6. Форматы ответов и ошибки
| Код | Сценарий                                  | Структура тела                                              |
|-----|-------------------------------------------|-------------------------------------------------------------|
| 200 | Успешное получение ресурса                | `{...данные...}`                                            |
| 201 | Успешное создание                         | `{...новая заявка...}`                                      |
| 400 | Ошибка валидации                          | `{"error":"validation_error","details":{"field":"message"}}`|
| 404 | Ресурс не найден                          | `{"error":"not_found","message":"Order not found"}`         |
| 500 | Непредвиденная ошибка сервера             | `{"error":"internal_server_error","message":"Unexpected..."}` |

Все ошибки логируются в stdout; при необходимости перенаправьте вывод сервиса в файл.

---

### 7. Тестовый сценарий end-to-end
1. **Создайте заявку** (см. §4.1).
2. **Проверьте список**:
   ```bash
   curl http://localhost:5000/api/v1/orders
   ```
3. **Извлеките заявку по ID**:
   ```bash
   curl http://localhost:5000/api/v1/orders/1
   ```
4. **Проверьте логи** в терминале: должна появиться запись `Created order TORO-YYYY-NNN ...`.

---

### 8. Обслуживание и отладка
- **Сброс БД:** остановите приложение, удалите `toro.db`, запустите снова — таблицы создадутся автоматически.
- **Смена директории БД:** используйте `TORO_DATABASE_URL`, полезно для контейнеризации или тестов.
- **Расширение API:** добавляйте новые статусы/приоритеты одновременно в `app.py`, документацию и UI.
- **CORS:** для продакшена ограничьте список доменов, передав `resources` в конструктор `CORS`.

---

### 9. Частые вопросы
- **Как запустить в Docker?** Установите зависимости внутри контейнера, смонтируйте проект и пробросьте порт `5000`.
- **Как сменить порт?** В файле `app.py` обновите параметр `port` в `app.run` и перезапустите сервис.
- **Можно ли обновлять статус заявки?** Текущая версия API поддерживает только создание и чтение. Для обновления статусной модели добавьте новый маршрут `PATCH /api/v1/orders/<id>`.

---

API готово к работе сразу после установки зависимостей. Руководство обновляется по мере развития функциональности; при изменениях схемы данных или правил валидации обязательно синхронизируйте этот документ и `README.md`.
