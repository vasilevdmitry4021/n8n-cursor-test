# Руководство пользователя — TORO Maintenance Orders API

Документ описывает рабочую версию сервиса из репозитория `n8n-cursor-test`. Руководство объединяет сведения из исходного кода и демонстрирует best practices для запуска, эксплуатации и интеграции API.

---

## 1. Назначение и сценарии использования
- Прием заявок на ремонт/ТО оборудования с фиксацией приоритета и статуса.
- Централизованный реестр заявок для диспетчеров и инженеров.
- Точка интеграции для n8n, внутренних UI и мобильных клиентов.

**Комментарий:** Логика сервиса полностью описана в `app.py`, поэтому любые интеграции обращаются именно к REST API.

## 2. Технологический стек и компоненты
- **Язык:** Python 3.11+
- **Фреймворк:** Flask (REST маршруты и обработка ошибок)
- **ORM:** Flask-SQLAlchemy (`database.py`, `models.py`)
- **Валидация:** Pydantic 2.x (`schemas.py`)
- **База данных:** SQLite (`toro.db` по умолчанию) или любой SQLAlchemy-совместимый движок
- **CORS:** Flask-CORS (по умолчанию разрешены все источники)

Структура модулей:
1. `app.py` — инициализация приложения, маршруты `/api/v1/orders`, обработка ошибок.
2. `database.py` — фабрика подключения к БД и создание таблиц.
3. `models.py` — модель `Order` с сериализацией и форматированием дат.
4. `schemas.py` — pydantic-схемы для тела запроса и фильтров.

## 3. Системные требования
- Python 3.11 или новее.
- `pip` и права записи в каталог проекта.
- ~100 МБ дискового пространства (виртуальное окружение + база).
- Сетевой доступ для установки зависимостей и внешних API (опционально).

## 4. Установка
```bash
git clone <repo_url> toro-api
cd toro-api
python -m venv .venv
source .venv/bin/activate      # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

**Комментарий:** держите виртуальное окружение рядом с проектом, чтобы упростить обновление зависимостей.

## 5. Конфигурация и база данных
- `TORO_DATABASE_URL` — строка подключения SQLAlchemy. По умолчанию `sqlite:///toro.db`.
- `SQLALCHEMY_ENGINE_OPTIONS.pool_pre_ping=True` гарантирует проверку соединения перед запросом.
- Для миграций в SQLite проще пересоздать файл (`rm toro.db`), после чего `init_db` повторно создаст таблицы.

**Best practice:** храните боевую БД вне репозитория и настраивайте переменную окружения через секреты CI/CD.

## 6. Запуск и эксплуатация
### 6.1 Локальный режим
```bash
source .venv/bin/activate
python app.py
# API доступно на http://localhost:5000
```

### 6.2 Production-рекомендации
- Запускайте через WSGI-сервер (`gunicorn app:app --bind 0.0.0.0:8000`).
- Ограничьте CORS до доверенных хостов (`CORS(app, resources={r"/api/*": {"origins": ["https://desk.example.com"]}})`).
- Настройте внешний PostgreSQL/MySQL и задайте `TORO_DATABASE_URL`.
- Проксируйте через Nginx с HTTPS.

## 7. Обзор REST API
| Метод | Путь | Назначение | Аутентификация |
|-------|------|------------|----------------|
| POST  | `/api/v1/orders` | Создание заявки | Нет (добавьте перед продом) |
| GET   | `/api/v1/orders` | Перечень заявок + фильтры | Нет |
| GET   | `/api/v1/orders/<id>` | Получение заявки по ID | Нет |
| PATCH | `/api/v1/orders/<id>/status` | Последовательное обновление статуса (Opus 4.5) | Нет |
| GET   | `/health` | Readiness/monitoring без авторизации | Нет |
| GET   | `/` | Краткое описание и ссылка на документацию | Нет |

## 8. Детали эндпоинтов
### 8.1 POST `/api/v1/orders`
- Обязательные поля: `equipment_type`, `equipment_id`, `issue_description`, `requester_name`, `department`, `contact_phone`, `contact_email`.
- Необязательные: `priority` (`low|medium|high`, default `medium`).
- `status` и `order_number` выставляются сервером.

Пример:
```bash
curl -X POST http://localhost:5000/api/v1/orders \
  -H "Content-Type: application/json" \
  -d '{
        "equipment_type": "Токарный станок",
        "equipment_id": "LAT-042",
        "issue_description": "Не работает подача резца",
        "priority": "high",
        "requester_name": "Петров П.П.",
        "department": "Цех №2",
        "contact_phone": "+7-911-222-33-44",
        "contact_email": "petrov@example.com"
      }'
```

### 8.2 GET `/api/v1/orders`
- Поддерживает параметры `priority`, `status`, `department`.
- Возвращает `{ "orders": [...], "total": N }` отсортированный по `created_at` (новые сверху).

### 8.3 GET `/api/v1/orders/<id>`
- Возвращает заявку по ID или `404 Not Found`.

### 8.4 PATCH `/api/v1/orders/<id>/status`
- Принимает JSON `{"status": "in_progress"}` или `{"status": "completed"}`.
- Переходы разрешены только в одну сторону: `created → in_progress → completed`.
- Повторная установка текущего значения выдаёт `400`, а попытка пропустить шаг — `409 Conflict`.
- Успешный ответ содержит обновлённый объект заказа и заголовок `X-Opus-Version: Opus 4.5`.

### 8.5 GET `/health`
- Возвращает `{"status": "ok", "spec_version": "Opus 4.5"}`.
- Подходит для readiness-проб Kubernetes/Nginx и внешнего мониторинга.
- Не обращается к базе данных, поэтому отвечает мгновенно и не нагружает систему.

### 8.6 GET `/`
- Минимальный landing-ответ с полями `message`, `spec_version`, `docs`.
- Удобно использовать как smoke-тест и ссылку на актуальный `USER_GUIDE.md`.

## 9. Модель данных `orders`
| Поле | Тип | Описание |
|------|-----|----------|
| `id` | Integer PK | Числовой идентификатор записи |
| `order_number` | String(20) | Уникальный номер в формате `TORO-YYYY-NNN` |
| `equipment_type` | String(120) | Краткое имя оборудования |
| `equipment_id` | String(120) | Инвентарный/серийный код |
| `issue_description` | Text | Описание проблемы (до 2000 символов) |
| `priority` | Enum | `low`, `medium`, `high`; default `medium` |
| `status` | Enum | `created`, `in_progress`, `completed`; default `created` |
| `requester_name` | String(120) | ФИО инициатора |
| `department` | String(120) | Подразделение |
| `contact_phone` | String(17) | Маска `+7-XXX-XXX-XX-XX` |
| `contact_email` | String | Валидный email |
| `created_at` | DateTime | ISO 8601 с суффиксом `Z` |
| `updated_at` | DateTime | Обновляется автоматически |

## 10. Валидация и бизнес-правила
- Pydantic запрещает дополнительные поля и обрезает пробелы (`extra="forbid", str_strip_whitespace=True`).
- `issue_description` ограничено 2000 символами.
- `contact_phone` строго проверяется регуляркой `+7-XXX-XXX-XX-XX`.
- `equipment_id` автоматически приводится к верхнему регистру и должен соответствовать `^[A-Z0-9-]{3,40}$` (критерии Opus 4.5).
- `department` нормализуется (лишние пробелы удаляются), пустые значения запрещены.
- `priority`, `status` и фильтры допустимы только из перечислений.
- При ошибке валидации возвращается `400` с полем `details`, где ключ — имя поля, значение — текст ошибки.

**Комментарий:** сервер генерирует номера заказов функцией `generate_order_number()` и не позволяет клиенту изменить статус напрямую — безопасность и целостность остаются на сервере.

## 11. Логирование и наблюдаемость
- Конфигурация логгера (`logging.basicConfig`) пишет время, уровень, имя логгера и сообщение.
- Успешное создание заявки логируется на уровне INFO, ошибки валидатора — WARNING, неожиданные сбои — ERROR.
- Для централизованного мониторинга перенаправьте stdout/stderr в системный журнал или используйте FileHandler.
- Каждому ответу автоматически добавляется заголовок `X-Opus-Version: Opus 4.5`, что помогает трекать клиентов, которые ещё не обновились до новой схемы.

## 12. Интеграция с n8n и внешними системами
1. Создайте HTTP Request node в n8n.
2. Укажите URL `POST http://<host>/api/v1/orders`.
3. В теле передавайте JSON с обязательными полями, значения можно собирать из предыдущих нод (например, Form Trigger).
4. Для чтения статуса используйте GET node и фильтры (`?department=Цех%203`).

**Best practice:** валидируйте данные до отправки (Function node) и логируйте ответы, чтобы видеть `order_number`.

## 13. Безопасность и best practices
- Включите аутентификацию перед продуктивным запуском (например, API key через middleware).
- Ограничьте CORS и добавьте rate limiting (Flask-Limiter).
- Никогда не храните `toro.db` в репозитории; добавьте его в `.gitignore`.
- Делайте резервные копии БД и логов.
- Настройте миграции (Alembic) перед расширением схемы.

## 14. Обработка ошибок и действия пользователя
| Код | Причина | Действия |
|-----|---------|----------|
| 400 | Невалидные данные | Исправьте поле из ответа `details` |
| 404 | Заявка не найдена | Проверьте ID или диапазон фильтров |
| 500 | Сбой сервера/БД | Просмотрите логи, убедитесь, что файл БД доступен |

**Комментарий:** при постоянной ошибке 500 в SQLite удалите `toro.db`, сервис создаст таблицу заново.

## 15. Контрольный список запуска
- [ ] Python ≥ 3.11 установлен, зависимости поставлены.
- [ ] Переменные `TORO_DATABASE_URL`, `FLASK_ENV` заданы (при необходимости).
- [ ] Приложение запущено (python app.py / gunicorn).
- [ ] Эндпоинты `POST` и `GET` протестированы вручную или через Postman/n8n.
- [ ] Логи сохраняются в централизованном хранилище.

Следуя этому руководству и комментариям, оператор получает воспроизводимый процесс развертывания, эксплуатации и расширения TORO Maintenance Orders API.

