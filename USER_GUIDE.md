# Руководство пользователя: TORO Maintenance Orders API

Документ описывает установку, настройку и практическое использование REST API для управления заявками на обслуживание/ремонт оборудования (ТОРО). Приложение написано на Flask, хранит данные в SQLite и автоматически создает базу при старте.

## 1. Архитектура и компоненты
- `app.py` — HTTP-сервер Flask, роуты `/api/v1/orders`, валидация входных данных и обработка ошибок.
- `models.py` — модель `Order` с полями заявки, правила автогенерации дат и сериализации в JSON.
- `database.py` — инициализация SQLAlchemy, чтение переменной `TORO_DATABASE_URL`, создание таблиц.
- `requirements.txt` — зафиксированные зависимости.
- `toro.db` — SQLite-файл (создается в корне проекта при первом запуске).

## 2. Требования и установка
1. Установите **Python 3.11+** и **pip**.
2. Склонируйте репозиторий и перейдите в каталог проекта.
3. Создайте виртуальное окружение и установите зависимости:
   ```bash
   python -m venv .venv
   source .venv/bin/activate          # Windows: .venv\Scripts\activate
   pip install -r requirements.txt
   ```

## 3. Настройка окружения
- По умолчанию база располагается в `sqlite:///toro.db`. Чтобы переопределить путь (например, вынести в защищенный каталог или использовать другую БД), задайте переменную `TORO_DATABASE_URL`:
  ```bash
  export TORO_DATABASE_URL=sqlite:////var/lib/toro/toro.db
  ```
- Дополнительных переменных не требуется. CORS включен для всех источников; при работе в продакшене ограничьте список доменов в `app.py`.

## 4. Запуск и проверка
1. В активированном окружении выполните:
   ```bash
   python app.py
   ```
2. Приложение слушает `http://127.0.0.1:5000`. При запуске автоматически создается база и таблица `orders`.
3. Проверьте доступность:
   ```bash
   curl http://127.0.0.1:5000/api/v1/orders
   ```
   Ответ `{"orders": [], "total": 0}` означает, что сервис работает корректно.

## 5. Структура данных
| Поле             | Тип/формат           | Обязательность | Описание |
|------------------|----------------------|----------------|----------|
| `order_number`   | `TORO-YYYY-NNN`      | авто           | Уникальный номер (год + порядковый номер) |
| `equipment_type` | строка ≤ 120         | да             | Тип оборудования |
| `equipment_id`   | строка ≤ 120         | да             | Инвентарный номер/ID |
| `issue_description` | текст            | да             | Подробное описание проблемы |
| `priority`       | `low/medium/high`    | да (по умолч. medium) | Важность выполнения |
| `status`         | `created/in_progress/completed` | авто (`created`) | Этап жизненного цикла |
| `requester_name` | строка ≤ 120         | да             | ФИО заказчика |
| `department`     | строка ≤ 120         | да             | Цех/подразделение |
| `contact_phone`  | `+7-XXX-XXX-XX-XX`   | да             | Контактный телефон |
| `created_at`     | ISO 8601             | авто           | Время создания |
| `updated_at`     | ISO 8601             | авто           | Время обновления |

## 6. Работа с API
Базовый URL: `http://127.0.0.1:5000/api/v1`.

| Метод и путь           | Назначение                      |
|------------------------|---------------------------------|
| `POST /orders`         | Создать новую заявку            |
| `GET /orders`          | Получить список заявок (с фильтрами) |
| `GET /orders/{id}`     | Получить одну заявку по ID      |

### 6.1 Создание заявки
```bash
curl -X POST http://127.0.0.1:5000/api/v1/orders \
  -H "Content-Type: application/json" \
  -d '{
        "equipment_type": "Конвейер",
        "equipment_id": "CONV-12",
        "issue_description": "Сильный износ роликового блока",
        "priority": "high",
        "requester_name": "Смирнов А.А.",
        "department": "Цех №1",
        "contact_phone": "+7-911-222-33-44"
      }'
```
Успешный ответ (`201 Created`) содержит полное описание заказа и присвоенный `order_number`.

### 6.2 Список заявок и фильтрация
```bash
# Все заявки
curl http://127.0.0.1:5000/api/v1/orders

# Только критичные заявки в работе из Цеха №3
curl "http://127.0.0.1:5000/api/v1/orders?priority=high&status=in_progress&department=Цех%20№3"
```
Возвращается JSON вида:
```json
{
  "orders": [ { ... }, { ... } ],
  "total": 2
}
```

### 6.3 Получение заявки по ID
```bash
curl http://127.0.0.1:5000/api/v1/orders/1
```
Ответ (`200 OK`) — объект заявки. Если ID не найден, возвращается `404 Not Found`.

## 7. Валидация и ответы об ошибках
- Все обязательные поля проверяются на непустые значения.
- `priority` и `status` допускают только значения из таблицы выше.
- Телефон должен строго соответствовать маске `+7-XXX-XXX-XX-XX`.
- При нарушении правил возвращается `400 Bad Request` с описанием вида:
  ```json
  {
    "error": "validation_error",
    "details": {
      "contact_phone": "Phone must match +7-XXX-XXX-XX-XX"
    }
  }
  ```
- Все ошибки серверной части или БД — `500 Internal Server Error`. Любая стандартная ошибка Flask также сериализуется в JSON.

## 8. Логирование и мониторинг
- Логи пишутся в stdout в формате `timestamp | level | logger | message`.
- Успешное создание заказа логируется уровнем `INFO` с номером заявки.
- Ошибки валидации — `WARNING`, неожиданные исключения — `ERROR`.
- Используйте переадресацию stdout или системные сервисы (например, `systemd`) для агрегирования логов.

## 9. Резервное копирование и обслуживание
- SQLite-файл `toro.db` можно копировать как обычный файл (желательно при остановленном сервисе).
- Для “чистой” базы удалите `toro.db` и перезапустите приложение — структура восстановится автоматически.
- Регулярно проверяйте размер файла и при необходимости выгружайте данные в CSV/JSON через `GET /orders`.

## 10. Частые вопросы
- **Не создается база** — проверьте права записи в каталоге и значение `TORO_DATABASE_URL`.
- **Ошибки CORS в браузере** — по умолчанию разрешены все источники; если меняли настройки CORS, убедитесь в корректности списка доменов.
- **Нужно изменить набор статусов/приоритетов** — обновите множества `PRIORITY_CHOICES` и `STATUS_CHOICES` в `app.py`, добавьте миграции при необходимости.

## 11. Проверка готовности к продакшену
1. Настройте внешний сервер (Gunicorn/uWSGI + reverse-proxy).
2. Перенесите SQLite в более надежное хранилище или используйте PostgreSQL, задав `TORO_DATABASE_URL=postgresql+psycopg://...`.
3. Ограничьте CORS и настройте аутентификацию на уровне ingress/proxy.
4. Добавьте бэкапы и мониторинг логов.

Следуя этому руководству, вы сможете развернуть сервис, протестировать его и использовать для реестра заявок ТОРО без дополнительной настройки кода.
